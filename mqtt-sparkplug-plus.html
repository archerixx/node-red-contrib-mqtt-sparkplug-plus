<!--
  Copyright JS Foundation and other contributors, http://js.foundation
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<style>

    #sparkplug-input-metric-container-row .red-ui-editableList-header {
        display: flex;
        background: var(--red-ui-tertiary-background);
        padding-right: 75px;
    }

    .mqtt-form-row-cols2 > input.mqtt-form-row-col1 {
        width: calc(35% - 75px);
    }
    .mqtt-form-row-cols2 > select.mqtt-form-row-col1 {
        width: calc(35% - 75px);
    }

    .mqtt-form-row-cols2 > label.mqtt-form-row-col2 {
        width: 100px;
        margin-left: 42px;
        display: inline-block;
    }
    .mqtt-form-row-cols2 > input.mqtt-form-row-col2 {
        width: calc(35% - 75px);
        display: inline-block;
    }
    .mqtt-form-row-cols2 > select.mqtt-form-row-col2 {
        width: calc(35% - 75px);
        display: inline-block;
    }
    .form-row.mqtt5-out > label {
        width: 130px;
    }
    .form-row.mqtt-flags-row > label {
        vertical-align: top;
    }
    .form-row.mqtt-flags-row > .mqtt-flags {
        display: inline-block;
        width: 70%
    }

    .form-row.mqtt-flags-row > .mqtt-flags > .mqtt-flag > label {
        display: block;
        width: 100%;
    }
    .form-row.mqtt-flags-row > .mqtt-flags > .mqtt-flag > label > input {
        position: relative;
        vertical-align: bottom;
        top: -2px;
        width: 15px;
        height: 15px;
    }
</style>

<script type="text/html" data-template-name="mqtt-sparkplug-broker">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> <span data-i18n="mqtt-sparkplug-plus.label.name"></span></label>
        <input type="text" id="node-config-input-name" data-i18n="[placeholder]mqtt-sparkplug-plus.label.name">
    </div>
    <div class="form-row">
        <ul style="min-width: 600px; margin-bottom: 20px;" id="node-config-mqtt-broker-tabs"></ul>
    </div>
    <div id="node-config-mqtt-broker-tabs-content" style="min-height:150px;">
        <div id="mqtt-broker-tab-connection" style="display:none">
            <div class="form-row node-input-broker">
                <label for="node-config-input-broker"><i class="fa fa-globe"></i> <span data-i18n="mqtt-sparkplug-plus.label.broker"></span></label>
                <input type="text" id="node-config-input-broker" style="width: calc(100% - 300px);" data-i18n="[placeholder]mqtt-sparkplug-plus.label.example">
                <label for="node-config-input-port" style="margin-left:20px; width:43px; "> <span data-i18n="mqtt-sparkplug-plus.label.port"></span></label>
                <input type="text" id="node-config-input-port" data-i18n="[placeholder]mqtt-sparkplug-plus.label.port" style="width:55px">
            </div>
            <div class="form-row" style="height: 34px;">
                <input type="checkbox" id="node-config-input-usetls" style="height: 34px; margin: 0 5px 0 104px; display: inline-block; width: auto; vertical-align: top;">
                <label for="node-config-input-usetls" style="width: 100px; line-height: 34px;"><span data-i18n="mqtt-sparkplug-plus.label.use-tls"></span></label>
                <span id="node-config-row-tls" class="hide"><input style="width: 320px;" type="text" id="node-config-input-tls"></span>
            </div>

            <div class="form-row">
                <label for="node-config-input-protocolVersion"><i class="fa fa-cog"></i> <span data-i18n="mqtt-sparkplug-plus.label.protocolVersion"></span></label>
                <select id="node-config-input-protocolVersion" style="width:70%;">
                    <!--<option value="3" data-i18n="mqtt-sparkplug-plus.label.protocolVersion3"></option> -->
                    <option value="4" data-i18n="mqtt-sparkplug-plus.label.protocolVersion4"></option>
                    <!-- <option value="5" data-i18n="mqtt-sparkplug-plus.label.protocolVersion5"></option> -->
                </select>
            </div>
            <div class="form-row">
                <label for="node-config-input-clientid"><i class="fa fa-tag"></i> <span data-i18n="mqtt-sparkplug-plus.label.clientid"></span></label>
                <input type="text" id="node-config-input-clientid" data-i18n="[placeholder]mqtt-sparkplug-plus.placeholder.clientid">
            </div>
            <div class="form-row">
                <label for="node-config-input-keepalive"><i class="fa fa-heartbeat"></i> <span data-i18n="mqtt-sparkplug-plus.label.keepalive"></span></label>
                <input type="number" min="0" id="node-config-input-keepalive" style="width: 100px">
            </div>
            <div class="form-row" style="margin-bottom:0">
                <label style="vertical-align:top;"><i class="fa fa-info"></i> <span data-i18n="mqtt-sparkplug-plus.label.session"></span></label>
                <div style="display: inline-block; width:calc(100% - 110px)">
                    <div class="form-row">
                        <label for="node-config-input-cleansession" style="width: auto;">
                            <input type="checkbox" id="node-config-input-cleansession" style="position: relative;vertical-align: bottom; top: -2px; width: 15px;height: 15px;">
                            <span id="node-config-input-cleansession-label" data-i18n="mqtt-sparkplug-plus.label.cleansession"></span>
                        </label>
                    </div>
                    <div class="form-row mqtt5">
                        <label style="width:auto" for="node-config-input-sessionExpiry"><span data-i18n="mqtt-sparkplug-plus.label.sessionExpiry"></span></label>
                        <input type="number" min="0" id="node-config-input-sessionExpiry" style="width: 100px" >
                    </div>
                </div>
            </div>
            <div class="form-row mqtt5">
                <label style="width: 125px;" for="node-config-input-userProps"><span data-i18n="mqtt-sparkplug-plus.label.userProperties"></span></label>
                <input type="text" id="node-config-input-userProps" style="width: calc(100% - 166px);">
            </div>
            <br>
        </div>
        <div id="mqtt-broker-tab-security" style="display:none">
            <div class="form-row">
                <label for="node-config-input-user"><i class="fa fa-user"></i> <span data-i18n="mqtt-sparkplug-plus.label.username"></span></label>
                <input type="text" id="node-config-input-user">
            </div>
            <div class="form-row">
                <label for="node-config-input-password"><i class="fa fa-lock"></i> <span data-i18n="mqtt-sparkplug-plus.label.password"></span></label>
                <input type="password" id="node-config-input-password">
            </div>
        </div>
         <div id="mqtt-broker-tab-sparkplug" style="display:none">
            <div class="form-row">
                <label for="node-config-input-eonName"><i class="fa fa-tag"></i> <span data-i18n="mqtt-sparkplug-plus.label.name"></span></label>
                <input type="text" id="node-config-input-eonName" data-i18n="[placeholder]mqtt-sparkplug-plus.label.name">
            </div>

            <div class="form-row">
                <label for="node-config-input-deviceGroup"><i class="fa fa-tasks"></i> <span>Group</span></label>
                <input type="text" id="node-config-input-deviceGroup" data-i18n="[placeholder]Sparkplug Devices">
            </div>
        </div>
    </div>
</script>

<script type="text/javascript">
(function() {

    var typedInputNoneOpt = { value: 'none', label: '', hasValue: false };
    var makeTypedInputOpt = function(value){
        return {
            value: value,
            label:value,
            hasValue: false
        }
    }

    RED.nodes.registerType('mqtt-sparkplug-broker',{
        category: 'config',
        defaults: {
            name: {value:"" },
            deviceGroup : {value:"",  validate :x => /^[^/+#]*$/.test(x) },
            eonName : {value:"",  validate :x => /^[^/+#]*$/.test(x) },
            broker: {value:"",required:true},
            port: {value:1883,required:false,validate:RED.validators.number(true)},
            tls: {type:"tls-config",required: false},
            clientid: {value:"", validate: function(v) {
                if ($("#node-config-input-clientid").length) {
                    // Currently editing the node
                    return $("#node-config-input-cleansession").is(":checked") || (v||"").length > 0;
                } else {
                    return (this.cleansession===undefined || this.cleansession) || (v||"").length > 0;
                }
            }},
            usetls: {value: false},
            verifyservercert: { value: false},
            compatmode: { value: false},
            protocolVersion: { value: 4},
            keepalive: {value:60,validate:RED.validators.number()},
            cleansession: {value: true},
            birthTopic: {value:""},
            birthQos: {value:"0"},
            birthRetain: {value:false},
            birthPayload: {value:""},
            birthMsg: { value: {}},
            closeTopic: {value:""},
            closeQos: {value:"0"},
            closeRetain: {value:false},
            closePayload: {value:""},
            closeMsg: { value: {}},
            willTopic: {value:""},
            willQos: {value:"0"},
            willRetain: {value:false},
            willPayload: {value:""},
            willMsg: { value: {}},
            sessionExpiry: {value:0}
        },
        credentials: {
            user: {type:"text"},
            password: {type: "password"}
        },
        label: function() {
            if (this.name) {
                return this.name;
            }
            var b = this.broker;
            if (!b) { b = "undefined"; }
            var lab = "";
            lab = (this.clientid?this.clientid+"@":"")+b;
            if (b.indexOf("://") === -1){
                if (!this.port){ lab = lab + ":1883"; }
                else { lab = lab + ":" + this.port; }
            }
            return lab;
        },
        oneditprepare: function () {
            var tabs = RED.tabs.create({
                id: "node-config-mqtt-broker-tabs",
                onchange: function(tab) {
                    $("#node-config-mqtt-broker-tabs-content").children().hide();
                    $("#" + tab.id).show();
                }
            });
            tabs.addTab({
                id: "mqtt-broker-tab-connection",
                label: this._("mqtt-sparkplug-plus.tabs-label.connection")
            });
            tabs.addTab({
                id: "mqtt-broker-tab-security",
                label: this._("mqtt-sparkplug-plus.tabs-label.security")
            });

           tabs.addTab({
                id: "mqtt-broker-tab-sparkplug",
                label: this._("mqtt-sparkplug-plus.tabs-label.sparkplug")
            });

          /*  function setUpSection(sectionId, v5Opts, isExpanded) {
                var birthMessageSection = $("#mqtt-broker-section-"+sectionId);
                var paletteHeader = birthMessageSection.find('.red-ui-palette-header');
                var twistie = paletteHeader.find('i');
                var sectionContent = birthMessageSection.find('.section-content');

                function toggleSection(expanded) {
                    twistie.toggleClass('expanded', expanded);
                    sectionContent.toggle(expanded);
                }
                paletteHeader.on("click", function(e) {
                    e.preventDefault();
                    var isExpanded = twistie.hasClass('expanded');
                    toggleSection(!isExpanded);
                });
                toggleSection(isExpanded);

                $("#node-config-input-"+sectionId+"-props").val(v5Opts?v5Opts.userProps:"").typedInput({
                    default:  !(v5Opts?v5Opts.userProps:null)? 'none':'json',
                    types: [typedInputNoneOpt, 'json'],
                });
                $("#node-config-input-"+sectionId+"-respTopic").val(v5Opts?v5Opts.respTopic:"").typedInput({
                    default:  !(v5Opts?v5Opts.respTopic:null)? 'none':'str',
                    types: [typedInputNoneOpt, 'str'],
                });
                $("#node-config-input-"+sectionId+"-correl").val(v5Opts?v5Opts.correl:"").typedInput({
                    default:  !(v5Opts?v5Opts.correl:null)? 'none':'str',
                    types: [typedInputNoneOpt, 'str'],
                });
                $("#node-config-input-"+sectionId+"-expiry").val(v5Opts?v5Opts.expiry:"").typedInput({
                    default:  !(v5Opts?v5Opts.expiry:null)? 'none':'num',
                    types: [typedInputNoneOpt, 'num'],
                });
            } */

            // show first section if none are set so the user gets the idea
            /*var showBirthSection = this.birthTopic !== ""
                || this.willTopic === ""
                && this.birthTopic === ""
                && this.closeTopic == "";
            setUpSection('birth', this.birthMsg, showBirthSection);
            setUpSection('close', this.closeMsg, this.closeTopic !== "");
            setUpSection('will', this.willMsg, this.willTopic !== "");

            if (this.willMsg) {
                $("#node-config-input-will-delay").val(this.willMsg.delay);
            }
*/
            setTimeout(function() { tabs.resize(); },0);
            if (typeof this.cleansession === 'undefined') {
                this.cleansession = true;
                $("#node-config-input-cleansession").prop("checked",true);
            }
            if (typeof this.usetls === 'undefined') {
                this.usetls = false;
                $("#node-config-input-usetls").prop("checked",false);
            }
            if (this.compatmode === 'true' || this.compatmode === true) {
                delete this.compatmode;
                this.protocolVersion = 4;
            }
            if (typeof this.protocolVersion === 'undefined') {
                this.protocolVersion = 4;
            }
            
            $("#node-config-input-protocolVersion").on("change", function() {
                //var v5 = $("#node-config-input-protocolVersion").val() == "5";
                //if(v5) {
                //    $("#node-config-input-cleansession-label").text(RED._("node-red:mqtt.label.cleanstart"))
                //    $("div.form-row.mqtt5").show();
                //} else {
                $("#node-config-input-cleansession-label").text(RED._("node-red:mqtt.label.cleansession"))
                $("div.form-row.mqtt5").hide();
                //}
            });
            $("#node-config-input-protocolVersion").val(this.protocolVersion);
          /*  $("#node-config-input-userProps").typedInput({
                default:  !this.userProps ? 'none':'json',
                types: [typedInputNoneOpt, 'json']
            });*/
           /*if (typeof this.keepalive === 'undefined') {
                this.keepalive = 15;
                $("#node-config-input-keepalive").val(this.keepalive);
            }
            if (typeof this.birthQos === 'undefined') {
                this.birthQos = "0";
                $("#node-config-input-birthQos").val("0");
            }
            if (typeof this.closeQos === 'undefined') {
                this.willQos = "0";
                $("#node-config-input-willQos").val("0");
            }
            if (typeof this.willQos === 'undefined') {
                this.willQos = "0";
                $("#node-config-input-willQos").val("0");
            }*/


            function updateTLSOptions() {
                if ($("#node-config-input-usetls").is(':checked')) {
                    $("#node-config-row-tls").show();
                } else {
                    $("#node-config-row-tls").hide();
                }
            }
            updateTLSOptions();
            $("#node-config-input-usetls").on("click",function() {
                updateTLSOptions();
            });
            var node = this;
            function updateClientId() {
                if ($("#node-config-input-cleansession").is(":checked")) {
                    $("#node-config-input-clientid").attr("placeholder",node._("mqtt-sparkplug-plus.placeholder.clientid"));
                } else {
                    $("#node-config-input-clientid").attr("placeholder",node._("mqtt-sparkplug-plus.placeholder.clientid-nonclean"));
                }
                $("#node-config-input-clientid").trigger("change");
            }
            setTimeout(updateClientId,0);
            $("#node-config-input-cleansession").on("click",function() {
                updateClientId();
            });

            function updatePortEntry(){
                var disabled = $("#node-config-input-port").prop("disabled");
                if ($("#node-config-input-broker").val().indexOf("://") === -1){
                    if (disabled){
                        $("#node-config-input-port").prop("disabled", false);
                    }
                }
                else {
                    if (!disabled){
                        $("#node-config-input-port").prop("disabled", true);
                    }
                }
            }
            $("#node-config-input-broker").on("change", function() {
                updatePortEntry();
            });
            $("#node-config-input-broker").on( "keyup", function() {
                updatePortEntry();
            });
            setTimeout(updatePortEntry,50);
            setTimeout(function() {
                $("#node-config-input-protocolVersion").trigger("change");
            },50);

        },
        oneditsave: function() {
            if (!$("#node-config-input-usetls").is(':checked')) {
                $("#node-config-input-tls").val("");
            }
            /*
            var v5 = $("#node-config-input-protocolVersion").val() == "5";

            function saveV5Message(section) {
                var msg = {};
                if ($("#node-config-input-"+section+"Topic").val().trim().length > 0) {
                    var contentType = $("#node-config-input-"+section+"-contentType").val().trim();
                    if (contentType === '') {
                        contentType = $("#node-config-input-"+section+"-contentType").typedInput('type');
                        if (contentType === 'none' || contentType === 'other') {
                            contentType = "";
                        }
                    }
                    if (contentType) {
                        msg.contentType = contentType;
                    }
                    var props = $("#node-config-input-"+section+"-props").val().trim();
                    if (props) {
                        msg.userProps = props;
                    }
                    var resp = $("#node-config-input-"+section+"-respTopic").val().trim();
                    if (props) {
                        msg.respTopic = resp;
                    }
                    var correl = $("#node-config-input-"+section+"-correl").val().trim();
                    if (correl) {
                        msg.correl = correl;
                    }
                    var expiry = $("#node-config-input-"+section+"-expiry").val().trim();
                    if (expiry) {
                        msg.expiry = expiry;
                    }
                }
                return msg;
            }

            if (v5) {
                this.birthMsg = saveV5Message("birth");
                this.closeMsg = saveV5Message("close");
                this.willMsg = saveV5Message("will");
                var willDelay = $("#node-config-input-will-delay").val();
                if (willDelay) {
                    this.willMsg.delay = willDelay;
                }
            } else {
                this.willMsg = {};
                this.birthMsg = {};
                this.closeMsg = {};
            }*/
        }
    });
})();
</script>

<!-- Sparkplug device -->
<script type="text/html" data-template-name="mqtt sparkplug device">
    <div class="form-row">
        <label for="node-input-broker"><i class="fa fa-globe"></i> <span data-i18n="[placeholder]Broker">Broker</span></label>
        <input type="text" id="node-input-broker">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="mqtt-sparkplug-plus.label.device"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]My Device">
    </div>

    <div class="form-row sparkplug-input-metric-row" style="margin-bottom: 0px;">
        <label><i class="fa fa-cubes"></i> <span data-i18n="mqtt-sparkplug-plus.label.metrics"></span></label>
    </div>
    <div class="form-row sparkplug-input-metric-row" id="sparkplug-input-metric-container-row">
        <ol id="sparkplug-input-metric-container"></ol>
    </div>

    <div class="form-tips"><span data-i18n="mqtt-sparkplug-plus.tip"></span></div>
</script>

<script type="text/javascript">
(function() {

    /**
    * Function that returns a list of configured Metrics
    * @return   {Object} A object with all configured metrics.
    */
    function getMetricsList() {
        var _metrics = {};
        var metrics = $("#sparkplug-input-metric-container").editableList("items");
        metrics.each(function(i) {
            var item = $(this);
            var name = item.find(".sparkplug-input-metric-name").val();
            var dt = item.find(".sparkplug-input-metric-dateType option:selected").text();
           
            if (name) {
                _metrics[name] = { dataType : dt};
            }
        });
        return _metrics;
    }

    RED.nodes.registerType('mqtt sparkplug device',{
        category: 'network',
        defaults: {
            name: {value:"",  validate :x => /^[^/+#]*$/.test(x) },
            metrics: {value:{}, required:true, validate : x => Object.keys(x).length > 0 },
            broker: {type:"mqtt-sparkplug-broker", required:true}
        },
        color:"#d8bfd8",
        inputs:1,
        outputs:1,
        icon: "bridge.svg",
        align: "right",
        label: function() {
            return this.name||"sparkplug device";
        },
        oneditprepare: function() {
            var that = this;
            // Setup model 
            var metricsList = $("#sparkplug-input-metric-container").editableList( {
                header: $("<div>").append($.parseHTML("<div style='width:80%; display: inline-grid'>Name</div><div style='display: inline-grid'>Type</div>")),
                addButton: "add",
                removable: true,
                height: 300,
                addItem: function(container,i,opt) {
                    var parent = container.parent();
                    var row = $("<div/>").addClass("sparkplug-input-metric").appendTo(container);
                    var fmoduleSpan = $("<span>").appendTo(row);
                    var fmodule = $("<input/>", {
                        class: "sparkplug-input-metric-name",
                        placeholder: "Metric Name",
                        type: "text"
                    }).css({
                    }).appendTo(fmoduleSpan).val(opt.name);

                    var selectField = $('<select/>',{
                        style:"width:110px; margin-left: 5px; text-align: center;",
                        class : "sparkplug-input-metric-dateType"
                    }).appendTo(row);
                    var group0 = $('<optgroup/>', { label: "Datatypes" }).appendTo(selectField);
                    var dataTypes = ["Int8", "Int16", "Int32", "Int64", "Float", "Double", "Boolean" , "String", "Unknown"]
                    for (var d in dataTypes) {
                        let option = $("<option></option>").val(d).text(dataTypes[d]);
                        group0.append(option);
                        if (dataTypes[d] === opt.dataType || (Object.keys(opt).length === 0 && dataTypes[d] === "Int32")) {
                            option.attr('selected','selected')
                        }
                    }
                }
            });
            var metrics = this.metrics || {};
       
            for (const [key, value] of Object.entries(metrics)) {
                value["name"] = key;
                metricsList.editableList('addItem', value)
            }
        },
        oneditsave: function() {
            var node = this;
            node.metrics = getMetricsList();
        },

        labelStyle: function() {
            return this.name?"node_label_italic":"";
        }
    });
})();
</script>
